apiVersion: v1
kind: Namespace
metadata:
  name: sourceless
  labels:
    name: sourceless
    app.kubernetes.io/name: sourceless
    app.kubernetes.io/part-of: sourceless-ecosystem

---
apiVersion: v1
kind: Secret
metadata:
  name: sourceless-secrets
  namespace: sourceless
type: Opaque
data:
  hostless-db-url: # Base64 encoded HOSTLESS database connection string
  jwt-secret: # Base64 encoded JWT secret key
  encryption-key: # Base64 encoded AES-256 encryption key
  redis-url: # Base64 encoded Redis connection string
  aws-access-key-id: # Base64 encoded AWS access key
  aws-secret-access-key: # Base64 encoded AWS secret key

---
apiVersion: v1
kind: ConfigMap
metadata:
  name: sourceless-global-config
  namespace: sourceless
data:
  global.json: |
    {
      "ecosystem": {
        "name": "Sourceless Blockchain Ecosystem",
        "version": "1.0.0",
        "environment": "production"
      },
      "blockchain": {
        "network": "mainnet",
        "chainId": "sourceless-1",
        "consensusAlgorithm": "HOSTLESS",
        "blockTime": 400,
        "maxBlockSize": "10MB",
        "ledgers": 6,
        "validators": {
          "required": 21,
          "total": 100
        }
      },
      "performance": {
        "targetTPS": 131300,
        "maxLatency": "100ms",
        "uptime": "99.9%"
      },
      "security": {
        "encryptionStandard": "AES-256-GCM",
        "hashAlgorithm": "SHA-256",
        "zkProofsEnabled": true,
        "multiSigRequired": true,
        "hsmIntegration": true
      },
      "monitoring": {
        "metricsRetention": "30d",
        "logRetention": "90d",
        "alertThresholds": {
          "cpu": 80,
          "memory": 85,
          "disk": 90,
          "errorRate": 5
        }
      }
    }

---
apiVersion: v1
kind: Service
metadata:
  name: redis
  namespace: sourceless
  labels:
    app: redis
spec:
  type: ClusterIP
  selector:
    app: redis
  ports:
  - port: 6379
    targetPort: 6379

---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: redis
  namespace: sourceless
  labels:
    app: redis
spec:
  replicas: 1
  selector:
    matchLabels:
      app: redis
  template:
    metadata:
      labels:
        app: redis
    spec:
      containers:
      - name: redis
        image: redis:7-alpine
        ports:
        - containerPort: 6379
        resources:
          requests:
            memory: "256Mi"
            cpu: "250m"
          limits:
            memory: "512Mi"
            cpu: "500m"
        volumeMounts:
        - name: redis-data
          mountPath: /data
      volumes:
      - name: redis-data
        persistentVolumeClaim:
          claimName: redis-pvc

---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: redis-pvc
  namespace: sourceless
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 10Gi
  storageClassName: gp3

---
apiVersion: v1
kind: Service
metadata:
  name: prometheus
  namespace: sourceless
  labels:
    app: prometheus
spec:
  type: ClusterIP
  selector:
    app: prometheus
  ports:
  - port: 9090
    targetPort: 9090

---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: prometheus
  namespace: sourceless
  labels:
    app: prometheus
spec:
  replicas: 1
  selector:
    matchLabels:
      app: prometheus
  template:
    metadata:
      labels:
        app: prometheus
    spec:
      containers:
      - name: prometheus
        image: prom/prometheus:latest
        ports:
        - containerPort: 9090
        args:
          - '--config.file=/etc/prometheus/prometheus.yml'
          - '--storage.tsdb.path=/prometheus/'
          - '--web.console.libraries=/etc/prometheus/console_libraries'
          - '--web.console.templates=/etc/prometheus/consoles'
          - '--storage.tsdb.retention.time=30d'
          - '--web.enable-lifecycle'
        resources:
          requests:
            memory: "1Gi"
            cpu: "500m"
          limits:
            memory: "2Gi"
            cpu: "1000m"
        volumeMounts:
        - name: prometheus-config
          mountPath: /etc/prometheus/
        - name: prometheus-storage
          mountPath: /prometheus/
      volumes:
      - name: prometheus-config
        configMap:
          name: prometheus-config
      - name: prometheus-storage
        persistentVolumeClaim:
          claimName: prometheus-pvc

---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: prometheus-pvc
  namespace: sourceless
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 100Gi
  storageClassName: gp3

---
apiVersion: v1
kind: ConfigMap
metadata:
  name: prometheus-config
  namespace: sourceless
data:
  prometheus.yml: |
    global:
      scrape_interval: 15s
      evaluation_interval: 15s

    rule_files:
      - "sourceless_rules.yml"

    scrape_configs:
      - job_name: 'sourceless-enterprise'
        static_configs:
          - targets: ['sourceless-enterprise:9090']
        scrape_interval: 5s

      - job_name: 'sourceless-light'
        static_configs:
          - targets: ['sourceless-light:9090']
        scrape_interval: 5s

      - job_name: 'kubernetes-pods'
        kubernetes_sd_configs:
          - role: pod
        relabel_configs:
          - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_scrape]
            action: keep
            regex: true
          - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_path]
            action: replace
            target_label: __metrics_path__
            regex: (.+)

    alerting:
      alertmanagers:
        - static_configs:
            - targets:
              - alertmanager:9093

  sourceless_rules.yml: |
    groups:
    - name: sourceless
      rules:
      - alert: HighErrorRate
        expr: rate(http_requests_total{status=~"5.."}[5m]) > 0.05
        for: 5m
        labels:
          severity: critical
        annotations:
          summary: High error rate detected
          description: "Error rate is {{ $value }} errors per second"

      - alert: HighMemoryUsage
        expr: (node_memory_MemTotal_bytes - node_memory_MemAvailable_bytes) / node_memory_MemTotal_bytes > 0.9
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: High memory usage
          description: "Memory usage is above 90%"

      - alert: LowTPS
        expr: rate(transactions_total[5m]) < 100000
        for: 10m
        labels:
          severity: warning
        annotations:
          summary: Transaction throughput below target
          description: "TPS is {{ $value }}, below target of 131,300"

---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: sourceless-network-policy
  namespace: sourceless
spec:
  podSelector:
    matchLabels:
      app: sourceless-enterprise
  policyTypes:
  - Ingress
  - Egress
  ingress:
  - from:
    - namespaceSelector:
        matchLabels:
          name: ingress-nginx
    - podSelector:
        matchLabels:
          app: sourceless-light
    ports:
    - protocol: TCP
      port: 3000
    - protocol: TCP
      port: 8080
  egress:
  - to:
    - podSelector:
        matchLabels:
          app: redis
    ports:
    - protocol: TCP
      port: 6379
  - to: []
    ports:
    - protocol: TCP
      port: 443
    - protocol: TCP
      port: 53
    - protocol: UDP
      port: 53